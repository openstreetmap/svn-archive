<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Simple OSM Editor Map Viewer</title>
    <script src="http://openlayers.org/api/OpenLayers.js"></script>
    <link rel="stylesheet" href="http://openlayers.org/api/theme/default/style.css" type="text/css" />
    <link rel="stylesheet" href="/static/base.css" type="text/css" />

    <style type="text/css">
       .potlatchLink {
        font-size: smaller;
        position: absolute;
        right: 7em;
        bottom: 17px;
        z-index: 10000;
       }
       .olControlPermalink {
        bottom: 3px;
       } 
       .olControlAttribution {
        bottom: 20px;
       } 
    </style>  
    <script type="text/javascript">
        var map, layer;
        var OSMEditor = {};
        OSMEditor.CreatePOIClick = OpenLayers.Class(OpenLayers.Control, {               
             title: 'Create POI',
             initialize: function(options) {
                 OpenLayers.Control.prototype.initialize.apply(
                     this, arguments
                 ); 
                 this.handler = new OpenLayers.Handler.Click(
                     this, {
                         'dblclick': this.onClick,
                     }, {
                         'double': true,
                         'stopDouble': true,
                         'single': false
                     }
                 );
             }, 

             onClick: function(evt) {
                 var xy = evt.xy;
                 var f = new OpenLayers.Format.XML();
                 var loc = map.getLonLatFromPixel(evt.xy);
                 loc.transform(map.getProjectionObject(), map.displayProjection);
                 var osm = f.createElementNS(null, "osm");
                 osm.setAttribute("version", "0.5");
                 var node = f.createElementNS(null, "node");
                 node.setAttribute("lon", loc.lon);
                 node.setAttribute("lat", loc.lat);
                 osm.appendChild(node);
                 var node = f.write(osm);
                 var request = OpenLayers.Request.PUT({
                     url: "/api/0.5/node/create",
                     data: node,
                     callback: this.handleResponse
                 });           
             },

             handleResponse: function(req) {
                 var id = req.responseText;
                 document.location = "/node/" + id;
             }
        });     
        OSMEditor.LoadDataClick = OpenLayers.Class(OpenLayers.Control, {                
             title: 'Browse OSM Data by clicking',
             initialize: function(options) {
                 OpenLayers.Control.prototype.initialize.apply(
                     this, arguments
                 ); 
                 this.handler = new OpenLayers.Handler.Click(
                     this, {
                         'click': this.onClick
                     }
                 );
             }, 

             onClick: function(evt) {
                 if (map.getResolution() > 30) {
                     alert("sorry, zoom in");
                     return;
                 }    
                 var output = document.getElementById("data");
                 var xy = evt.xy;
                 var b = new OpenLayers.Bounds();
                 b.extend(map.getLonLatFromPixel(new OpenLayers.Pixel(xy.x-30, xy.y-30)));
                 b.extend(map.getLonLatFromPixel(new OpenLayers.Pixel(xy.x+30, xy.y+30)));
                 this.lastLonLat = b.getCenterLonLat();
                 if (this.selectFeature) {
                     this.selectFeature.destroy();
                 }    
                 if (this.layers) {
                     for (var i = 0; i <this.layers.length; i++) {
                         this.layers[i].destroy();
                     }
                 }
                 $("data").innerHTML = "";
                 $("loading").innerHTML = "Loading...";
                 var styleMap = new OpenLayers.StyleMap({'default': OpenLayers.Util.extend(OpenLayers.Feature.Vector.style['default'], {strokeWidth: 5, cursor: 'pointer'})});

                 this.layers = []
                 this.layers.push(
                     new OpenLayers.Layer.GML("", 
                         "/api/0.5/map?bbox="+b.clone().transform(map.getProjectionObject(), map.displayProjection).toBBOX(), 
                         {format: OpenLayers.Format.OSM, styleMap: styleMap, projection: map.displayProjection}));
                 
                 var selectFeature = new OpenLayers.Control.SelectFeature(this.layers[0]);
                 var click = this;
                 for (var i = 0; i < this.layers.length; i++) {
                     
                     this.layers[i].events.on({
                     'featureselected': 
                         function(e) {
                             var feature = e.feature;
                             var type = "way"; 
                             if (feature.geometry.CLASS_NAME == "OpenLayers.Geometry.Point") {
                                 type = "node";
                             }    
                             var s = "<a href='/" + type +"/" + feature.osm_id +"'>Edit "+ type + " " + feature.osm_id + "</a>";
                             var tags = "<ul>"; 
                             for (var key in feature.attributes) {
                                 if (key.search(":") == -1) {
                                     tags += "<li><b>" + key + "</b>: " + feature.attributes[key] + "</li>";
                                 }
                             }
                             tags += "</ul>";
                             document.getElementById("data").innerHTML = s + tags;
                         },
                     'featureunselected': function () {
                         $("data").innerHTML = "";

                     },
                     "loadend": 
                         function() { 
                             $("loading").innerHTML = this.features.length + " loaded";
                             if (this.features.length == 1) {
                                 selectFeature.select(this.features[0]);
                             } else {
                                 var matches = [];
                                 var point = new OpenLayers.Geometry.Point(click.lastLonLat.lon, click.lastLonLat.lat); 
                                 for (var i = 0; i < this.features.length; i++) {
                                      if (this.features[i].geometry.intersects(point)) {
                                         matches.push(this.features[i]);
                                      }
                                 }
                                 if (matches.length == 1) {
                                     selectFeature.select(matches[0]);
                                 }    
                             }
                                 
                         }    
                     });
                 }    
                 this.selectFeature = selectFeature;
                 map.addControl(this.selectFeature);
                 this.selectFeature.activate();
                 
                 map.addLayers(this.layers);
             }

         }); 
        function onPopupClose(evt) {
            selectControl.unselect(selectedFeature);
        }
        function onFeatureSelect(feature) {
            selectedFeature = feature;
            popup = new OpenLayers.Popup.FramedCloud("featurePopup", 
                                     feature.geometry.getBounds().getCenterLonLat(),
                                     null,
                                     "<div style='font-size:.8em'>Feature: " + feature.attributes.osm_id +"<br />Area: " + feature.geometry.getArea()+"</div>",
                                     null, true, onPopupClose);
            feature.popup = popup;
            map.addPopup(popup);
        }
        function onFeatureUnselect(feature) {
            map.removePopup(feature.popup);
            feature.popup.destroy();
            feature.popup = null;
        }    
        function init(){
            var options = {
                projection: new OpenLayers.Projection("EPSG:900913"),
                displayProjection: new OpenLayers.Projection("EPSG:4326"),
                units: "m",
                maxResolution: 156543.03392804062,
                numZoomLevels: 19,
                maxExtent: new OpenLayers.Bounds(-20037508.342787, -20037508.342788, 20037508.342789, 20037508.342789 )
            };

            map = new OpenLayers.Map( 'map', options );
            layer = new OpenLayers.Layer.WMS( "OpenLayers WMS",
                    "http://labs.metacarta.com/wms/vmap0",
                    {layers: 'basic'} );
            var mapnik = new OpenLayers.Layer.TMS(
                "OpenStreetMap (Mapnik)",
                  ["http://a.tile.openstreetmap.org/",
                   "http://b.tile.openstreetmap.org/"],
                {
                    type: 'png', getURL: osm_getTileURL,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/">OpenStreetMap</a> Contributors',
                    buffer: 0
                }
            );

            var panel = new OpenLayers.Control.Panel({displayClass: 'mainMapToolbar'});
            panel.addControls(new OSMEditor.LoadDataClick({
                'displayClass': 'loadData'
            }));
            panel.addControls(new OSMEditor.CreatePOIClick({
                'displayClass': 'createPoi'
            }));
            map.addControl(panel);
            panel.activate();
            panel.activateControl(panel.controls[0]);
            map.addControl(new OpenLayers.Control.Permalink());
            map.addControl(new OpenLayers.Control.Permalink($("potlatchLinkHref"), "http://openstreetmap.org/edit.html", {displayClass: 'potlatchLink'}));
            map.addLayer(mapnik);
            if (!map.getCenter()) { map.zoomToMaxExtent(); }
        }
        function osm_getTileURL(bounds) {
            var res = this.map.getResolution();
            var x = Math.round((bounds.left - this.maxExtent.left) / (res * this.tileSize.w));
            var y = Math.round((this.maxExtent.top - bounds.top) / (res * this.tileSize.h));
            var z = this.map.getZoom();
            var limit = Math.pow(2, z);

            if (y < 0 || y >= limit || x < 0 || x >= limit) {
                return OpenLayers.Util.getImagesLocation() + "blank.gif";
            } else {
                x = ((x % limit) + limit) % limit;
                var path = z + "/" + x + "/" + y + "." + this.type;
                var url = this.url;
                if (url instanceof Array) {
                    url = this.selectUrl(path, url);
                }
                return url + path;
            }
        }

    </script>
  </head>

  <body onload="init()">
    <div id="map" style="width:99%; height:99%">
        <div id="data" style="position:absolute; left: 5px; bottom:5px; z-index:10000; background-color: white; padding: 5px"></div>
        <div id="loading" style="position:absolute; right: 5px; top:25px; z-index:10000"></div>
        <div class="potlatchLink"><a id="potlatchLinkHref">Edit (with Potlatch)</a></div>
    </div>

  </body>
</html>


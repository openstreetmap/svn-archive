<project name="JOSM i18n" default="build" basedir=".">

  <!-- compilation properties -->
  <property name="josm.build.dir"    value="../core"/>
  <property name="josm.presets"      value="${josm.build.dir}/presets/presets.xml"/>
  <property name="josm.style"        value="${josm.build.dir}/styles/standard/elemstyles.xml"/>
  <property name="plugin.dir"        value="../plugins"/>
  <property name="validator.tagfile" value="${plugin.dir}/validator/tagchecker.cfg"/>
  <property name="wms.srcfile"       value="${plugin.dir}/wmsplugin/sources.cfg"/>
  <property name="surveyor.srcfile"  value="${plugin.dir}/surveyor/resources/surveyor.xml"/>
  <property name="i18n.build.dir"    value="build"/>
  <property name="i18n.install.dir"  value="${josm.build.dir}/lib"/>
  <property name="i18n.name"         value="josm-translation"/>
  <property name="i18n.jar"          value="${i18n.install.dir}/${i18n.name}.jar"/>

  <property name="ant.build.javac.target" value="1.5"/>

  <property name="gettexttasks.jar" value="lib/gettext-ant-tasks-0.9.6.jar"/>

  <target name="init.gettext" description="Loads the Ant gettext tasks">
    <taskdef name="gettext-extract" classname="org.xnap.commons.ant.gettext.GettextExtractKeysTask" classpath="${gettexttasks.jar}"/>
    <taskdef name="gettext-merge" classname="org.xnap.commons.ant.gettext.GettextMergeKeysTask" classpath="${gettexttasks.jar}"/>
    <taskdef name="gettext-dist" classname="org.xnap.commons.ant.gettext.GettextDistTask" classpath="${gettexttasks.jar}"/>
  </target>

  <target name="trans_.java">
    <mkdir dir="${i18n.build.dir}"/>
    <exec executable="perl" output="${i18n.build.dir}/trans_presets.java">
      <arg line="convpreset.pl ${josm.presets}"/>
    </exec>
    <exec executable="perl" output="${i18n.build.dir}/trans_style.java">
      <arg line="convstyle.pl ${josm.style}"/>
    </exec>
    <exec executable="perl" output="${i18n.build.dir}/trans_validator.java">
      <arg line="convvalidator.pl ${validator.tagfile}"/>
    </exec>
    <exec executable="perl" output="${i18n.build.dir}/trans_wms.java">
      <arg line="convwms.pl ${wms.srcfile}"/>
    </exec>
    <exec executable="perl" output="${i18n.build.dir}/trans_surveyor.java">
      <arg line="convsurveyor.pl ${surveyor.srcfile}"/>
    </exec>
    <exec executable="perl" output="${i18n.build.dir}/trans_plugins.java">
      <arg line="convplugins.pl ${plugin.dir}/*/build.xml"/>
    </exec>
    <copy file="specialmessages.java" todir="${i18n.build.dir}" />
  </target>

  <target name="po/josm.pot"
          description="Extracts message keys from the source code"
          depends="trans_.java,init.gettext">
    <gettext-extract keysFile="josm.pot" poDirectory="po"
                     keywords="-k -ktrc -ktr -kmarktr -ktrn:1,2 -ktrl">
      <fileset dir="${josm.build.dir}/src" includes="**/*.java"/>
      <fileset dir="${plugin.dir}" includes="**/*.java"/>
      <fileset dir="${i18n.build.dir}" includes="specialmessages.java"/>
      <fileset dir="${i18n.build.dir}" includes="trans_*.java"/>
    </gettext-extract>
  </target>

  <target name="build" depends="po/josm.pot,init.gettext">
    <copy file="i18n.properties" todir="build/org/openstreetmap/josm" />

    <gettext-merge keysFile="josm.pot" poDirectory="po"/>

    <!--<gettext-dist targetBundle="org.openstreetmap.josm.i18n.Translation"
                  poDirectory="po" outputDirectory="build"/>-->
    <ant target="build-lang"><property name="language" value="ar"/></ant>
    <ant target="build-lang"><property name="language" value="bg"/></ant>
    <ant target="build-lang"><property name="language" value="cs"/></ant>
    <ant target="build-lang"><property name="language" value="da"/></ant>
    <ant target="build-lang"><property name="language" value="de"/></ant>
    <ant target="build-lang"><property name="language" value="el"/></ant>
    <ant target="build-lang"><property name="language" value="en_GB"/></ant>
    <ant target="build-lang"><property name="language" value="es"/></ant>
    <ant target="build-lang"><property name="language" value="et"/></ant>
    <ant target="build-lang"><property name="language" value="fi"/></ant>
    <ant target="build-lang"><property name="language" value="fr"/></ant>
    <ant target="build-lang"><property name="language" value="gl"/></ant>
    <ant target="build-lang"><property name="language" value="he"/><property name="jlanguage" value="iw_IL"/></ant>
    <ant target="build-lang"><property name="language" value="ja"/></ant>
    <ant target="build-lang"><property name="language" value="is"/></ant>
    <ant target="build-lang"><property name="language" value="it"/></ant>
    <ant target="build-lang"><property name="language" value="nb"/></ant>
    <ant target="build-lang"><property name="language" value="nl"/></ant>
    <ant target="build-lang"><property name="language" value="pl"/></ant>
    <ant target="build-lang"><property name="language" value="pt_BR"/></ant>
    <ant target="build-lang"><property name="language" value="ro"/></ant>
    <ant target="build-lang"><property name="language" value="ru"/></ant>
    <ant target="build-lang"><property name="language" value="sk"/></ant>
    <ant target="build-lang"><property name="language" value="sl"/></ant>
    <ant target="build-lang"><property name="language" value="sv"/></ant>
    <ant target="build-lang"><property name="language" value="tr"/></ant>
    <ant target="build-lang"><property name="language" value="zh_TW"/></ant>

    <exec append="false" output="REVISION" executable="svn" failifexecutionfails="false">
      <env key="LANG" value="C"/>
      <arg value="info"/>
      <arg value="--xml"/>
      <arg value="po"/>
    </exec>
    <xmlproperty file="REVISION" prefix="version" keepRoot="false" collapseAttributes="true"/>
    <delete file="REVISION"/>

    <jar destfile="${i18n.jar}" basedir="build" excludes="**/*.java">
      <manifest>
        <attribute name="Extension-Name" value="JOSM Translation into various languages" />
        <attribute name="Translation-Version" value="${version.entry.commit.revision}"/>
        <attribute name="Translation-Date" value="${version.entry.commit.date}"/>
      </manifest>
    </jar>
  </target>

  <target name="build-lang">
    <property name="jlanguage" value="${language}"/>
    <exec executable="msgfmt">
      <arg line="--verbose --java2 -dbuild -rorg.openstreetmap.josm.i18n.Translation -l${jlanguage} po/${language}.po"/>
    </exec>
  </target>

  <target name="clean">
    <delete dir="${i18n.build.dir}" />
    <delete file="po/josm.pot"/>
    <delete>
      <fileset dir="po" includes="*.*~" defaultexcludes="false"/>
    </delete>
  </target>

</project>

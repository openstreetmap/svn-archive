<?xml version="1.0" encoding="utf-8"?>
<project name="JOSM i18n" default="build" basedir=".">
    <!-- compilation properties -->
    <property name="josm.build.dir" value="../core"/>
    <property name="josm.presets" value="${josm.build.dir}/data/defaultpresets.xml"/>
    <property name="josm.style" value="${josm.build.dir}/styles/standard/elemstyles.xml"/>
    <property name="plugin.dir" value="../plugins"/>
    <property name="validator.tagfile" value="${josm.build.dir}/data/tagchecker.cfg"/>
    <property name="wms.srcfile" value="http://josm.openstreetmap.de/maps"/>
    <property name="surveyor.srcfile" value="${plugin.dir}/surveyor/resources/surveyor.xml"/>
    <property name="i18n.build.dir" value="build"/>
    <property name="i18n.install.dir" value="${josm.build.dir}/data"/>
    <property name="po.build.dir" value="${i18n.build.dir}"/>
    <property name="ant.build.javac.target" value="1.5"/>
    <property name="gettexttasks.jar" value="lib/gettext-ant-tasks-0.9.7.jar"/>
    <property name="antcontrib.jar" value="lib/ant-contrib-1.0b3.jar"/>
    <target name="init" description="Loads the Ant gettext and contrib tasks">
        <taskdef name="gettext-extract" classname="org.xnap.commons.ant.gettext.GettextExtractKeysTask" classpath="${gettexttasks.jar}"/>
        <taskdef name="gettext-merge" classname="org.xnap.commons.ant.gettext.GettextMergeKeysTask" classpath="${gettexttasks.jar}"/>
        <taskdef name="gettext-dist" classname="org.xnap.commons.ant.gettext.GettextDistTask" classpath="${gettexttasks.jar}"/>
        <taskdef resource="net/sf/antcontrib/antcontrib.properties" classpath="${antcontrib.jar}"/>
    </target>
    <target name="trans_.java">
        <mkdir dir="${i18n.build.dir}"/>
        <exec executable="perl" failonerror="true" output="${i18n.build.dir}/trans_presets.java">
            <arg line="convpreset.pl ${josm.presets}"/>
        </exec>
        <exec executable="perl" output="${i18n.build.dir}/trans_style.java">
            <arg line="convstyle.pl ${josm.style}"/>
        </exec>
        <exec executable="perl" output="${i18n.build.dir}/trans_validator.java">
            <arg line="convvalidator.pl ${validator.tagfile}"/>
        </exec>
        <exec executable="perl" output="${i18n.build.dir}/trans_wms.java">
            <arg line="convwms.pl ${wms.srcfile}"/>
        </exec>
        <exec executable="perl" output="${i18n.build.dir}/trans_surveyor.java">
            <arg line="convsurveyor.pl ${surveyor.srcfile}"/>
        </exec>
        <exec executable="perl" output="${i18n.build.dir}/trans_plugins.java">
            <arg line="convplugins.pl ${plugin.dir}/*/build.xml"/>
        </exec>
        <copy file="specialmessages.java" todir="${i18n.build.dir}"/>
    </target>
    <target name="po/josm.pot" description="Extracts message keys from the source code" depends="trans_.java,init">
        <gettext-extract keysFile="josm.pot" poDirectory="po" keywords="-k -ktrc:1c,2 -kmarktrc:1c,2 -ktr -kmarktr -ktrn:1,2 -ktrnc:1c,2,3">
            <fileset dir="${josm.build.dir}/src" includes="**/*.java"/>
            <fileset dir="${i18n.build.dir}" includes="specialmessages.java"/>
            <fileset dir="${i18n.build.dir}" includes="trans_*.java"/>
            <fileset dir="${plugin.dir}" includes="**/*.java"/>
        </gettext-extract>
    </target>
    <target name="build" depends="po/josm.pot,init">
        <gettext-merge keysFile="josm.pot" poDirectory="po"/>
        <antcall target="coretrans"/>
        <foreach param="path" target="plugintrans">
            <path>
                <dirset dir="${plugin.dir}" includes="*"/>
            </path>
        </foreach>
    </target>
    <target name="coretrans">
        <mkdir dir="${po.build.dir}/core"/>
        <gettext-extract keysFile="josm.pot" poDirectory="${po.build.dir}/core" keywords="-k -ktrc:1c,2 -kmarktrc:1c,2 -ktr -kmarktr -ktrn:1,2 -ktrnc:1c,2,3">
            <fileset dir="${josm.build.dir}/src" includes="**/*.java"/>
            <fileset dir="${i18n.build.dir}" includes="specialmessages.java"/>
            <fileset dir="${i18n.build.dir}" includes="trans_*.java"/>
        </gettext-extract>
        <copy todir="${po.build.dir}/core">
            <fileset dir="po"/>
        </copy>
        <gettext-merge keysFile="josm.pot" poDirectory="${po.build.dir}/core"/>
        <exec executable="perl">
            <arg line="i18n.pl ${i18n.install.dir}/ ${po.build.dir}/core/*.po"/>
        </exec>
    </target>
    <target name="plugintrans" depends="init">
        <basename file="${path}" property="dir"/>
        <mkdir dir="${po.build.dir}/plugin_${dir}"/>
        <gettext-extract keysFile="josm.pot" poDirectory="${po.build.dir}/plugin_${dir}" keywords="-k -ktrc:1c,2 -kmarktrc:1c,2 -ktr -kmarktr -ktrn:1,2 -ktrnc:1c,2,3">
            <fileset dir="${plugin.dir}/${dir}" includes="**/*.java"/>
        </gettext-extract>
        <if>
            <available file="${po.build.dir}/plugin_${dir}/josm.pot"/>
            <then>
                <copy todir="${po.build.dir}/plugin_${dir}">
                    <fileset dir="po"/>
                </copy>
                <gettext-merge keysFile="josm.pot" poDirectory="${po.build.dir}/plugin_${dir}"/>
                <exec executable="perl">
                    <arg line="i18n.pl ${plugin.dir}/${dir}/data/ ${po.build.dir}/plugin_${dir}/*.po"/>
                </exec>
            </then>
        </if>
    </target>
    <target name="clean">
        <delete dir="${i18n.build.dir}"/>
        <delete file="po/josm.pot"/>
        <delete>
            <fileset dir="po" includes="*.*~" defaultexcludes="false"/>
        </delete>
    </target>
    <target name="test">
        <mkdir dir="${i18n.build.dir}/test"/>
        <exec executable="perl">
            <arg line="i18n.pl ${i18n.build.dir}/test/ po/*.po"/>
        </exec>
    </target>
</project>

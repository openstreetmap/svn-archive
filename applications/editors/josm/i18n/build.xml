<project name="JOSM i18n" default="build" basedir=".">

  <!-- compilation properties -->
  <property name="josm.build.dir"    value="../core"/>
  <property name="josm.presets"      value="${josm.build.dir}/presets/presets.xml"/>
  <property name="josm.style"        value="${josm.build.dir}/styles/standard/elemstyles.xml"/>
  <property name="plugin.dir"        value="../plugins"/>
  <property name="validator.tagfile" value="${plugin.dir}/validator/tagchecker.cfg"/>
  <property name="wms.srcfile"       value="${plugin.dir}/wmsplugin/sources.cfg"/>
  <property name="surveyor.srcfile"  value="${plugin.dir}/surveyor/resources/surveyor.xml"/>
  <property name="i18n.build.dir"    value="build"/>
  <property name="i18n.install.dir"  value="${josm.build.dir}/lib"/>
  <property name="i18n.name"         value="josm-translation"/>
  <property name="i18n.jar"          value="${i18n.install.dir}/${i18n.name}.jar"/>

  <property name="ant.build.javac.target" value="1.5"/>

  <target name="trans_.java">
    <mkdir dir="${i18n.build.dir}"/>
    <exec executable="perl" output="${i18n.build.dir}/trans_presets.java">
      <arg line="convpreset.pl ${josm.presets}"/>
    </exec>
    <exec executable="perl" output="${i18n.build.dir}/trans_style.java">
      <arg line="convstyle.pl ${josm.style}"/>
    </exec>
    <exec executable="perl" output="${i18n.build.dir}/trans_validator.java">
      <arg line="convvalidator.pl ${validator.tagfile}"/>
    </exec>
    <exec executable="perl" output="${i18n.build.dir}/trans_wms.java">
      <arg line="convwms.pl ${wms.srcfile}"/>
    </exec>
    <exec executable="perl" output="${i18n.build.dir}/trans_surveyor.java">
      <arg line="convsurveyor.pl ${surveyor.srcfile}"/>
    </exec>
  </target>

  <target name="java_sourcefiles.txt" depends="trans_.java">
    <exec executable="find" osfamily="unix"
          output="${i18n.build.dir}/java_sources.txt">
      <arg value="${josm.build.dir}/src" />
      <arg value="${plugin.dir}"/>
      <arg value="${i18n.build.dir}"/>
      <arg value="-name"/>
      <arg value="*.java"/>
    </exec>
    <exec executable="sort" osfamily="unix"
          output="${i18n.build.dir}/java_sourcefiles.txt">
      <arg value="${i18n.build.dir}/java_sources.txt"/>
    </exec>
    <delete file="${i18n.build.dir}/java_sources.txt"/>
  </target>

  <target name="po/josm.pot"
          description="Extracts message keys from the source code"
          depends="java_sourcefiles.txt">
    <exec executable="xgettext">
      <arg line="-ktr -ktrn:1,2 -ktrc -kmarktr -Ljava --from-code=UTF-8 -opo/josm.pot -f${i18n.build.dir}/java_sourcefiles.txt"/>
    </exec>
  </target>

  <target name="build" depends="po/josm.pot">
    <copy file="i18n.properties" todir="build/org/openstreetmap/josm" />

    <ant target="build-lang"><property name="language" value="bg"/></ant>
    <ant target="build-lang"><property name="language" value="cs"/></ant>
    <ant target="build-lang"><property name="language" value="da"/></ant>
    <ant target="build-lang"><property name="language" value="de"/></ant>
    <ant target="build-lang"><property name="language" value="el"/></ant>
    <ant target="build-lang"><property name="language" value="en_GB"/></ant>
    <ant target="build-lang"><property name="language" value="es"/></ant>
    <ant target="build-lang"><property name="language" value="fi"/></ant>
    <ant target="build-lang"><property name="language" value="fr"/></ant>
    <ant target="build-lang"><property name="language" value="he"/><property name="jlanguage" value="iw_IL"/></ant>
    <ant target="build-lang"><property name="language" value="ja"/></ant>
    <ant target="build-lang"><property name="language" value="it"/></ant>
    <ant target="build-lang"><property name="language" value="nl"/></ant>
    <ant target="build-lang"><property name="language" value="pl"/></ant>
    <ant target="build-lang"><property name="language" value="ro"/></ant>
    <ant target="build-lang"><property name="language" value="ru"/></ant>
    <ant target="build-lang"><property name="language" value="sk"/></ant>
    <ant target="build-lang"><property name="language" value="sl"/></ant>
    <ant target="build-lang"><property name="language" value="sv"/></ant>
    <ant target="build-lang"><property name="language" value="tr"/></ant>

    <exec append="false" output="REVISION" executable="svn" failifexecutionfails="false">
      <env key="LANG" value="C"/>
      <arg value="info"/>
      <arg value="--xml"/>
      <arg value="po"/>
    </exec>
    <xmlproperty file="REVISION" prefix="version" keepRoot="false" collapseAttributes="true"/>
    <delete file="REVISION"/>

    <jar destfile="${i18n.jar}" basedir="build"
         excludes="trans_*.java java_sourcefiles.txt">
      <manifest>
        <attribute name="Extension-Name" value="JOSM Translation into various languages" />
        <attribute name="Translation-Version" value="${version.entry.commit.revision}"/>
        <attribute name="Translation-Date" value="${version.entry.commit.date}"/>
      </manifest>
    </jar>

  </target>

  <target name="build-lang">
    <property name="jlanguage" value="${language}"/>
    <exec executable="msgmerge">
      <arg line="-U po/${language}.po po/josm.pot"/>
    </exec>

    <exec executable="msgfmt">
      <arg line="--verbose --java2 -dbuild -rorg.openstreetmap.josm.i18n.Translation -l${jlanguage} po/${language}.po"/>
    </exec>
  </target>

  <target name="clean">
    <delete dir="${i18n.build.dir}" />
    <delete file="po/josm.pot"/>
    <delete>
      <fileset dir="po" includes="*.po~" defaultexcludes="false"/>
    </delete>
  </target>

</project>

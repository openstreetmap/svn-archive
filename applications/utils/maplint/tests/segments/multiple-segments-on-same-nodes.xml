<?xml version='1.0' encoding='iso-8859-1' ?>
<maplint:test group="segments" id="multiple-segments-on-same-nodes" version="1" severity="error"
    xmlns:maplint="http://maplint.openstreetmap.org/xml/1.0"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform">

    <maplint:desc xml:lang="en">
        Find segments which use the same nodes. Either with the same direction
        or with different directions.
    </maplint:desc>

    <maplint:setup type="application/xsl+xml">
        <xsl:key name="fromto2segment" match="/osm/segment" use="concat(@from, ' ', @to)"/>
        <xsl:key name="tofrom2segment" match="/osm/segment" use="concat(@to, ' ', @from)"/>
    </maplint:setup>

    <maplint:check data="segment" type="application/xsl+xml">
        <xsl:variable name="segment-samedir" select="key('fromto2segment', concat(@from, ' ', @to))"/>
        <xsl:variable name="segment-otherdir" select="key('tofrom2segment', concat(@to, ' ', @from))"/>
        <xsl:variable name="sid" select="@id"/>
        <xsl:if test="count($segment-samedir) &gt; 1">
            <maplint:result>
                <xsl:text>Segments with same @from/@to:</xsl:text>
                <xsl:for-each select="$segment-samedir">
                    <xsl:if test="@id != $sid">
                        <xsl:value-of select="concat(' ', @id)"/>
                    </xsl:if>
                </xsl:for-each>
            </maplint:result>
        </xsl:if>
        <xsl:if test="count($segment-otherdir) &gt; 1">
                <xsl:text>Segments with @from/@to reversed:</xsl:text>
                <xsl:for-each select="$segment-otherdir">
                    <xsl:if test="@id != $sid">
                        <xsl:value-of select="concat(' ', @id)"/>
                    </xsl:if>
                </xsl:for-each>
        </xsl:if>
    </maplint:check>

</maplint:test>

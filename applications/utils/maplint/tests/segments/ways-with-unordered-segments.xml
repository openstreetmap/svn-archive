<?xml version='1.0' encoding='iso-8859-1' ?>
<maplint:test group="segments" id="ways-with-unordered-segments" version="1" severity="error"
    xmlns:maplint="http://maplint.openstreetmap.org/xml/1.0"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform">

    <maplint:desc xml:lang="en">
        Ways in which the segments are not ordered and sequenced properly.
    </maplint:desc>

    <maplint:setup type="application/xsl+xml">
        <xsl:key name="segment" match="/osm/segment" use="@id"/>
    </maplint:setup>

    <maplint:check data="way" type="application/xsl+xml">
        <xsl:variable name="error">
            <xsl:for-each select="seg">
                <xsl:if test="position() != last()">
                    <xsl:variable name="thissegment" select="key('segment',@id)"/>
                    <xsl:variable name="next" select="position()+1"/>
                    <xsl:variable name="nextsegment" select="key('segment',../seg[$next]/@id)"/>
                    <xsl:variable name="to" select="$thissegment/@to"/>
                    <xsl:variable name="from" select="$nextsegment/@from"/>
                    <xsl:if test="$to != $from">
                        <xsl:text>fail</xsl:text>
                    </xsl:if>
                </xsl:if>
            </xsl:for-each>
        </xsl:variable>

        <xsl:if test="$error != ''">
            <maplint:result/>
        </xsl:if>
    </maplint:check>

</maplint:test>

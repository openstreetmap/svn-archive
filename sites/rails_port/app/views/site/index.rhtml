<%= render :partial => 'search' %>

<% if params['mlon'] and params['mlat'] %>
<% marker = true %>
<% mlon = params['mlon'] %> 
<% mlat = params['mlat'] %>
<% end %>

<% if params['minlon'] and params['minlat'] and params['maxlon'] and params['maxlat'] %>
<% bbox = true %>
<% minlon = params['minlon'] %>
<% minlat = params['minlat'] %>
<% maxlon = params['maxlon'] %>
<% maxlat = params['maxlat'] %>
<% end %>

<% if params['lon'] and params['lat'] %>
<% lon =  params['lon'] %>
<% lat =  params['lat'] %>
<% zoom =  params['zoom'] || '5' %>
<% layers = params['layers'] %>
<% elsif params['mlon'] and params['mlat'] %>
<% lon = params['mlon'] %> 
<% lat = params['mlat'] %>
<% zoom =  params['zoom'] || '12' %>
<% layers = params['layers'] %>
<% elsif cookies.key?("location") %>
<% lon,lat,zoom,layers = cookies["location"].value.first.split(",") %>
<% elsif @user and !@user.home_lon.nil? and !@user.home_lat.nil? %> 
<% lon =  @user.home_lon %>
<% lat =  @user.home_lat %>
<% zoom = '10' %>
<% else %>
<% lon =  '-0.1' %>
<% lat =  '51.5' %>
<% zoom =  params['zoom'] || '5' %>
<% layers = params['layers'] %>
<% end %>

<script type="text/javascript" src="/openlayers/OpenLayers.js"></script>
<%= javascript_include_tag 'map.js' %>

<% unless @user %>
<script src="http://www.mappam.com/javascripts/mappam.js" type="text/javascript"></script>
<% end %>


<script type="text/javascript">
  <!--
  var ie = navigator.appName.indexOf("Microsoft Internet Explorer") != -1;
  var map;

  function init(){
    var map = createMap("map");

    <% if bbox %>
    var min = lonLatToMercator(new OpenLayers.LonLat(<%= minlon %>, <%= minlat %>));
    var max = lonLatToMercator(new OpenLayers.LonLat(<%= maxlon %>, <%= maxlat %>));
    var bbox = new OpenLayers.Bounds(min.lon, min.lat, max.lon, max.lat);

    map.zoomToExtent(bbox);
    <% else %>
    var centre = lonLatToMercator(new OpenLayers.LonLat(<%= lon %>, <%= lat %>));
    var zoom = <%= zoom %>;

    <% if params['scale'] and params['scale'].length > 0 then %>
    zoom = scaleToZoom(<%= params['scale'].to_f() %>);
    <% end %>

    map.setCentre(centre, zoom);
    <% end %>

    <% if marker %>
    addMarkerToMap(lonLatToMercator(new OpenLayers.LonLat(<%= mlon %>, <%= mlat %>)));
    <% end %>

    <% if layers %>
    setMapLayers("<%= layers %>");
    <% end %>

    map.events.register("moveend", map, updateLocation);
    updateLocation();

    <% unless @user %>
    if ( window.location.hostname == "www.openstreetmap.org" ) { 
      mappam.register( map, '10011756636067178496', '1');
    } else if( window.location.hostname == "openstreetmap.org" ) {
      mappam.register( map, '6738410720121976832', '1');
    }
    <% end %>

    document.getElementById('map_OpenLayers_ViewPort').style.position = 'absolute';
    if ( ie ) {
      handleResize();
    }
  }        

  function updateLocation() {
    var lonlat = mercatorToLonLat(map.getCenter());
    var zoom = map.getZoom();
    var layers = getMapLayers();

    updatelinks(lonlat.lon, lonlat.lat, zoom, layers);

    document.cookie = "location=" + lonlat.lon + "," + lonlat.lat + "," + zoom + "," + layers;
  }

  function getStyle( el, property ) {
    var style;
    if( el.currentStyle ) {
        style = el.currentStyle[property];
    } else if( window.getComputedStyle ) {
        style = document.defaultView.getComputedStyle(el,null).getPropertyValue(property);
    } else {
        style = el.style[property];
    }
    return style;
  }
  
  function handleResize() {
    var el = document.getElementById( 'map' );
    var left = getStyle( el, 'left' );
    var top = getStyle( el, 'top' );
    var bottom = getStyle( el, 'bottom' );
    var right = getStyle( el, 'right' );
    var width = el.old_width;
    var height;
    if( ! width ) {
        width = getStyle( el, 'width' );
    }
    var height = el.old_height;
    if( ! height ) {
        height = getStyle( el, 'height' );
    }
    var pwidth, pheight;
    if( el.offsetParent.nodeName == 'BODY' || el.offsetParent.nodeName == 'HTML' ) {
      if( typeof( window.innerWidth ) == 'number' ) {
          pwidth = window.innerWidth;
          pheight = window.innerHeight;
      } else if( document.documentElement &&
          ( document.documentElement.clientWidth || document.documentElement.clientHeight ) ) {
          pwidth = document.documentElement.clientWidth;
          pheight = document.documentElement.clientHeight;
      } else if( document.body && ( document.body.clientWidth || document.body.clientHeight ) ) {
          pwidth = document.body.clientWidth;
          pheight = document.body.clientHeight;
      }
    } else {
      pwidth = el.offsetParent.offsetWidth;
      pheight = el.offsetParent.offsetHeight;
    }
    if( left != 'auto' && right != 'auto' && width == 'auto' ) {
      el.old_width = width;
      var new_width = (pwidth - el.offsetLeft - parseInt( right ) );
      el.style.width = new_width + 'px';
    }
    if( top != 'auto' && bottom != 'auto' && height == 'auto' ) {
      el.old_height = height;
      var new_height = (pheight - el.offsetTop - parseInt( bottom ) );
      el.style.height = new_height + 'px';
    }
    map.updateSize();
    el.style.display = 'none';
    setTimeout( function() { el.style.display = ''; }, 200 );
  }

  if ( ie ) {
    window.onresize = handleResize;
  }

  window.onload = init;
// -->
</script>
